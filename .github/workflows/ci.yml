name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Print toolchain versions
        run: |
          echo "=== Go ==="
          go version
          echo ""
          echo "=== Clang ==="
          clang --version
          echo ""
          echo "=== LLVM Tools ==="
          which opt && opt --version || echo "opt not found"
          which llvm-as && llvm-as --version || echo "llvm-as not found"

      - name: Build compiler
        run: make build

      - name: Run doctor
        run: make doctor

      - name: Run smoke test
        run: make smoke

      - name: Run layout test
        run: make layout-test

      - name: Run Go tests
        run: go test ./...

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run go vet
        run: go vet ./...

      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy" && exit 1)
